package com.yourapp.electricitycounter.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Calculate
import androidx.compose.material.icons.filled.Clear
import androidx.compose.material.icons.filled.Lock
import androidx.compose.material.icons.filled.LockOpen
import androidx.compose.material.icons.filled.Speed
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Spacer
import androidx.compose.material.icons.filled.Money
import androidx.compose.material.icons.filled.History
import androidx.compose.material3.IconButton

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CalculatorScreen(
    onNavigateToReminders: () -> Unit,
    onNavigateToHistory: () -> Unit
) {
    var currentReading by remember { mutableStateOf("") }
    var tariff by remember { mutableStateOf("5.5") }
    var previousReading by remember { mutableStateOf("1000") }
    var isTariffLocked by remember { mutableStateOf(true) }
    var isPreviousLocked by remember { mutableStateOf(true) }
    var resultText by remember { mutableStateOf("") }
    
    Scaffold { paddingValues ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(
                    brush = Brush.verticalGradient(
                        colors = listOf(
                            Color(0xFF0F2027),
                            Color(0xFF203A43),
                            Color(0xFF2C5364)
                        )
                    )
                )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(paddingValues)
                    .verticalScroll(rememberScrollState())
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –º–æ–ª–Ω–∏–µ–π
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text(
                        text = "‚ö°",
                        fontSize = 48.sp,
                        color = Color(0xFFFFD700)
                    )
                    Text(
                        text = "–≠–ª–µ–∫—Ç—Ä–æ—Å—á—ë—Ç—á–∏–∫",
                        fontSize = 28.sp,
                        fontWeight = FontWeight.Bold,
                        color = Color.White
                    )
                    Text(
                        text = "–£—á—ë—Ç –∏ —Ä–∞—Å—á—ë—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏",
                        fontSize = 14.sp,
                        color = Color(0xFFAAAAAA)
                    )
                }
                
                Spacer(modifier = Modifier.height(8.dp))
                
                // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±—ã
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Button(
                        onClick = { /* –£–∂–µ —Ç—É—Ç */ },
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = Color(0xFF1E3C72)
                        )
                    ) {
                        Text("–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä")
                    }
                    
                    Button(
                        onClick = onNavigateToReminders,
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = Color(0xFF2A5298)
                        )
                    ) {
                        Text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è")
                    }
                    
                    Button(
                        onClick = onNavigateToHistory,
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = Color(0xFFFF8C00)
                        )
                    ) {
                        Text("–ò—Å—Ç–æ—Ä–∏—è")
                    }
                }
                
                // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color.White
                    ),
                    elevation = CardDefaults.cardElevation(8.dp)
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        // –¢–∞—Ä–∏—Ñ —Å –∑–∞—â–∏—Ç–æ–π
                        Column {
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.SpaceBetween,
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Row(verticalAlignment = Alignment.CenterVertically) {
                                    Icon(
                                        Icons.Default.Money,
                                        contentDescription = "–¢–∞—Ä–∏—Ñ",
                                        tint = Color(0xFF28A745)
                                    )
                                    Spacer(modifier = Modifier.padding(4.dp))
                                    Text(
                                        text = "–¢–∞—Ä–∏—Ñ (—Ä—É–±/–∫–í—Ç¬∑—á)",
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                                Text(
                                    text = "–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å 01.01.2024",
                                    fontSize = 12.sp,
                                    color = Color.Gray,
                                    modifier = Modifier
                                        .background(Color(0xFFF7FAFC))
                                        .padding(horizontal = 8.dp, vertical = 4.dp)
                                )
                            }
                            OutlinedTextField(
                                value = tariff,
                                onValueChange = { tariff = it },
                                modifier = Modifier.fillMaxWidth(),
                                enabled = !isTariffLocked,
                                trailingIcon = {
                                    IconButton(
                                        onClick = { isTariffLocked = !isTariffLocked }
                                    ) {
                                        Icon(
                                            if (isTariffLocked) Icons.Default.Lock else Icons.Default.LockOpen,
                                            contentDescription = "–ó–∞—â–∏—Ç–∞",
                                            tint = if (isTariffLocked) Color.Gray else Color(0xFF28A745)
                                        )
                                    }
                                },
                                suffix = { Text(" ‚ÇΩ") }
                            )
                        }
                        
                        // –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å –∑–∞—â–∏—Ç–æ–π
                        Column {
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.SpaceBetween,
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Row(verticalAlignment = Alignment.CenterVertically) {
                                    Icon(
                                        Icons.Default.History,
                                        contentDescription = "–ò—Å—Ç–æ—Ä–∏—è",
                                        tint = Color(0xFF6F42C1)
                                    )
                                    Spacer(modifier = Modifier.padding(4.dp))
                                    Text(
                                        text = "–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è",
                                        fontWeight = FontWeight.Bold
                                    )
                                }
                                Text(
                                    text = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
                                    fontSize = 12.sp,
                                    color = Color.Gray,
                                    modifier = Modifier
                                        .background(Color(0xFFF7FAFC))
                                        .padding(horizontal = 8.dp, vertical = 4.dp)
                                )
                            }
                            OutlinedTextField(
                                value = previousReading,
                                onValueChange = { previousReading = it },
                                modifier = Modifier.fillMaxWidth(),
                                enabled = !isPreviousLocked,
                                trailingIcon = {
                                    IconButton(
                                        onClick = { isPreviousLocked = !isPreviousLocked }
                                    ) {
                                        Icon(
                                            if (isPreviousLocked) Icons.Default.Lock else Icons.Default.LockOpen,
                                            contentDescription = "–ó–∞—â–∏—Ç–∞",
                                            tint = if (isPreviousLocked) Color.Gray else Color(0xFF28A745)
                                        )
                                    }
                                },
                                suffix = { Text(" –∫–í—Ç¬∑—á") }
                            )
                        }
                        
                        // –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è
                        Column {
                            Row(verticalAlignment = Alignment.CenterVertically) {
                                Icon(
                                    Icons.Default.Speed,
                                    contentDescription = "–°—á–µ—Ç—á–∏–∫",
                                    tint = Color(0xFF007BFF)
                                )
                                Spacer(modifier = Modifier.padding(4.dp))
                                Text(
                                    text = "–¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è",
                                    fontWeight = FontWeight.Bold
                                )
                            }
                            OutlinedTextField(
                                value = currentReading,
                                onValueChange = { currentReading = it },
                                modifier = Modifier.fillMaxWidth(),
                                placeholder = { Text("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è") },
                                suffix = { Text(" –∫–í—Ç¬∑—á") }
                            )
                        }
                    }
                }
                
                // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    Button(
                        onClick = {
                            // –†–∞—Å—á–µ—Ç
                            val current = currentReading.toDoubleOrNull()
                            val prev = previousReading.toDoubleOrNull()
                            val tar = tariff.toDoubleOrNull()
                            
                            if (current != null && prev != null && tar != null) {
                                if (current < prev) {
                                    resultText = "‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –º–µ–Ω—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö!"
                                } else {
                                    val consumption = current - prev
                                    val amount = consumption * tar
                                    resultText = """
                                        üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞:
                                        
                                        –ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ: ${String.format("%.1f", consumption)} –∫–í—Ç¬∑—á
                                        –¢–∞—Ä–∏—Ñ: ${String.format("%.2f", tar)} ‚ÇΩ/–∫–í—Ç¬∑—á
                                        –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: ${String.format("%.2f", amount)} ‚ÇΩ
                                        
                                        ‚úÖ –†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!
                                    """.trimIndent()
                                }
                            } else {
                                resultText = "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
                            }
                        },
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = Color(0xFFFF8C00)
                        )
                    ) {
                        Icon(Icons.Default.Calculate, contentDescription = null)
                        Spacer(modifier = Modifier.padding(4.dp))
                        Text("–†–∞—Å—Å—á–∏—Ç–∞—Ç—å")
                    }
                    
                    OutlinedButton(
                        onClick = { 
                            currentReading = ""
                            tariff = "5.5"
                            previousReading = "1000"
                            isTariffLocked = true
                            isPreviousLocked = true
                            resultText = ""
                        },
                        modifier = Modifier.weight(1f)
                    ) {
                        Icon(Icons.Default.Clear, contentDescription = null)
                        Spacer(modifier = Modifier.padding(4.dp))
                        Text("–û—á–∏—Å—Ç–∏—Ç—å")
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                if (resultText.isNotEmpty()) {
                    Card(
                        modifier = Modifier.fillMaxWidth(),
                        colors = CardDefaults.cardColors(
                            containerColor = Color(0xFFD4EDDA)
                        ),
                        elevation = CardDefaults.cardElevation(4.dp)
                    ) {
                        Column(modifier = Modifier.padding(16.dp)) {
                            Text(
                                text = "üìà –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞",
                                fontWeight = FontWeight.Bold,
                                color = Color(0xFF155724),
                                fontSize = 18.sp
                            )
                            Spacer(modifier = Modifier.height(8.dp))
                            Text(
                                text = resultText,
                                color = Color(0xFF155724),
                                fontSize = 14.sp,
                                lineHeight = 20.sp
                            )
                        }
                    }
                }
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color(0xFFE7F3FF)
                    )
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Text(
                            text = "üí° –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:",
                            fontWeight = FontWeight.Bold,
                            color = Color(0xFF1E3C72)
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            text = "1. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–∞\n" +
                                  "2. –ù–∞–∂–º–∏—Ç–µ '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å'\n" +
                                  "3. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ\n" +
                                  "4. –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π - –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–º–æ–∫ üîí",
                            color = Color(0xFF666666),
                            fontSize = 13.sp,
                            lineHeight = 18.sp
                        )
                    }
                }
            }
        }
    }
}